#!/bin/bash
# scripts/backup-mongodb.sh

# MongoDB Backup Script

set -e

# Configuration
BACKUP_DIR="/backups/mongodb"
RETENTION_DAYS=30
MONGODB_URI="${MONGODB_URI:-mongodb://localhost:27017}"
DATABASE_NAME="${DATABASE_NAME:-portfolio}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="backup_${DATABASE_NAME}_${TIMESTAMP}"

# Create backup directory
mkdir -p "$BACKUP_DIR"

echo "Starting MongoDB backup..."

# Perform backup
mongodump \
  --uri="$MONGODB_URI" \
  --db="$DATABASE_NAME" \
  --out="$BACKUP_DIR/$BACKUP_NAME" \
  --gzip

# Check if backup was successful
if [ $? -eq 0 ]; then
  echo "Backup completed successfully: $BACKUP_NAME"
  
  # Create tar archive
  cd "$BACKUP_DIR"
  tar -czf "${BACKUP_NAME}.tar.gz" "$BACKUP_NAME"
  rm -rf "$BACKUP_NAME"
  
  # Upload to cloud storage (optional)
  if [ -n "$S3_BUCKET" ]; then
    echo "Uploading backup to S3..."
    aws s3 cp "${BACKUP_NAME}.tar.gz" "s3://${S3_BUCKET}/mongodb-backups/" \
      --storage-class STANDARD_IA
    
    if [ $? -eq 0 ]; then
      echo "Backup uploaded to S3"
    else
      echo "Failed to upload backup to S3"
    fi
  fi
  
  # Remove old backups
  echo "Cleaning up old backups..."
  find "$BACKUP_DIR" -name "backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete
  
  echo "Backup process completed"
else
  echo "Backup failed!"
  exit 1
fi