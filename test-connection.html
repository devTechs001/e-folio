<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Folio Connection Tester</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-top: 0; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .info { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç E-Folio Connection Diagnostic Tool</h1>
        <p class="info">This tool tests the connection between your frontend and backend.</p>

        <div class="test-section">
            <h3>Environment Variables</h3>
            <div id="envVars"></div>
        </div>

        <div class="test-section">
            <h3>1. Backend Health Check</h3>
            <button onclick="testBackendHealth()">Test Backend Health</button>
            <div id="healthResult"></div>
        </div>

        <div class="test-section">
            <h3>2. API Endpoint Test (with /api prefix)</h3>
            <button onclick="testAPIEndpoint()">Test API Auth Endpoint</button>
            <div id="apiResult"></div>
        </div>

        <div class="test-section">
            <h3>3. CORS Test</h3>
            <button onclick="testCORS()">Test CORS Configuration</button>
            <div id="corsResult"></div>
        </div>

        <div class="test-section">
            <h3>4. Full Connection Test</h3>
            <button onclick="runAllTests()">Run All Tests</button>
            <div id="allTestsResult"></div>
        </div>
    </div>

    <script>
        // Display environment variables
        function displayEnvVars() {
            const apiUrl = typeof import.meta !== 'undefined' && import.meta.env ? import.meta.env.VITE_API_URL : 'Not available in plain HTML';
            const socketUrl = typeof import.meta !== 'undefined' && import.meta.env ? import.meta.env.VITE_SOCKET_URL : 'Not available in plain HTML';
            
            document.getElementById('envVars').innerHTML = `
                <div class="result warning">
                    <strong>Note:</strong> This is a standalone HTML file. Environment variables are only available in the built Vite app.<br><br>
                    <strong>Expected Production URLs:</strong><br>
                    ‚Ä¢ VITE_API_URL: <code>https://e-folio-backend-server.onrender.com/api</code><br>
                    ‚Ä¢ VITE_SOCKET_URL: <code>https://e-folio-backend-server.onrender.com</code>
                </div>
            `;
        }

        async function testBackendHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.innerHTML = '<div class="loader"></div> Testing...';

            const backendUrl = 'https://e-folio-backend-server.onrender.com';
            
            try {
                const response = await fetch(`${backendUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ <strong>Backend is running!</strong><br>
                            Status: ${response.status}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            ‚ùå Backend returned error<br>
                            Status: ${response.status}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå <strong>Connection Failed!</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>Possible causes:</strong><br>
                        ‚Ä¢ Backend server is down<br>
                        ‚Ä¢ Network/firewall issue<br>
                        ‚Ä¢ URL is incorrect<br>
                        ‚Ä¢ CORS blocking request
                    </div>
                `;
            }
        }

        async function testAPIEndpoint() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="loader"></div> Testing...';

            const apiUrl = 'https://e-folio-backend-server.onrender.com/api';
            
            try {
                // Test a public endpoint that should return 401 or similar
                const response = await fetch(`${apiUrl}/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ <strong>API endpoint is reachable!</strong><br>
                            Status: ${response.status} (Expected - no auth token provided)<br>
                            This means the API is working correctly.
                        </div>
                    `;
                } else {
                    const data = await response.text();
                    resultDiv.innerHTML = `
                        <div class="result warning">
                            ‚ö†Ô∏è API responded with status: ${response.status}<br>
                            Response: ${data}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå <strong>API Connection Failed!</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>This is the issue!</strong> The /api endpoint is not reachable.
                    </div>
                `;
            }
        }

        async function testCORS() {
            const resultDiv = document.getElementById('corsResult');
            resultDiv.innerHTML = '<div class="loader"></div> Testing...';

            try {
                const response = await fetch('https://e-folio-backend-server.onrender.com/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });

                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods')
                };

                resultDiv.innerHTML = `
                    <div class="result success">
                        ‚úÖ <strong>CORS is configured</strong><br>
                        <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                        ${corsHeaders['access-control-allow-origin'] === null ? 
                            '<br>‚ö†Ô∏è Warning: No CORS headers found. This might cause issues.' : 
                            ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå CORS test failed: ${error.message}
                    </div>
                `;
            }
        }

        async function runAllTests() {
            const resultDiv = document.getElementById('allTestsResult');
            resultDiv.innerHTML = '<div class="loader"></div> Running all tests...';

            await testBackendHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAPIEndpoint();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCORS();

            resultDiv.innerHTML = `
                <div class="result success">
                    ‚úÖ All tests completed! Check results above.
                </div>
            `;
        }

        // Display env vars on load
        displayEnvVars();
    </script>
</body>
</html>
